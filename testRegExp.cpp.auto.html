<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>testRegExp.cpp</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">testRegExp.cpp&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 *  Copyright (C) 2011 Apple Inc. All rights reserved.
 *
 *  This library is free software; you can redistribute it and/or
 *  modify it under the terms of the GNU Library General Public
 *  License as published by the Free Software Foundation; either
 *  version 2 of the License, or (at your option) any later version.
 *
 *  This library is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 *  Library General Public License for more details.
 *
 *  You should have received a copy of the GNU Library General Public License
 *  along with this library; see the file COPYING.LIB.  If not, write to
 *  the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
 *  Boston, MA 02110-1301, USA.
 *
 */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;config.h&quot;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;RegExp.h&quot;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;wtf/CurrentTime.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;InitializeThreading.h&quot;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;JSGlobalObject.h&quot;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;UStringBuilder.h&quot;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;errno.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdio.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdlib.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;string.h&gt;</span>

#<span class="enscript-reference">if</span> !<span class="enscript-variable-name">OS</span>(<span class="enscript-variable-name">WINDOWS</span>)
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;unistd.h&gt;</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">HAVE</span>(<span class="enscript-variable-name">SYS_TIME_H</span>)
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/time.h&gt;</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">COMPILER</span>(<span class="enscript-variable-name">MSVC</span>) &amp;&amp; !<span class="enscript-variable-name">OS</span>(<span class="enscript-variable-name">WINCE</span>)
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;crtdbg.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mmsystem.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;windows.h&gt;</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">PLATFORM</span>(<span class="enscript-variable-name">QT</span>)
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;QCoreApplication&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;QDateTime&gt;</span>
#<span class="enscript-reference">endif</span>

<span class="enscript-type">const</span> <span class="enscript-type">int</span> MaxLineLength = 100 * 1024;

using namespace JSC;
using namespace WTF;

<span class="enscript-type">struct</span> CommandLine {
    CommandLine()
        : interactive(false)
        , verbose(false)
    {
    }

    <span class="enscript-type">bool</span> interactive;
    <span class="enscript-type">bool</span> verbose;
    Vector&lt;UString&gt; arguments;
    Vector&lt;UString&gt; files;
};

<span class="enscript-type">class</span> StopWatch {
<span class="enscript-type">public</span>:
    <span class="enscript-type">void</span> start();
    <span class="enscript-type">void</span> stop();
    <span class="enscript-type">long</span> getElapsedMS(); <span class="enscript-comment">// call stop() first
</span>
<span class="enscript-type">private</span>:
    <span class="enscript-type">double</span> m_startTime;
    <span class="enscript-type">double</span> m_stopTime;
};

<span class="enscript-type">void</span> <span class="enscript-function-name">StopWatch::start</span>()
{
    m_startTime = currentTime();
}

<span class="enscript-type">void</span> <span class="enscript-function-name">StopWatch::stop</span>()
{
    m_stopTime = currentTime();
}

<span class="enscript-type">long</span> <span class="enscript-function-name">StopWatch::getElapsedMS</span>()
{
    <span class="enscript-keyword">return</span> static_cast&lt;<span class="enscript-type">long</span>&gt;((m_stopTime - m_startTime) * 1000);
}

<span class="enscript-type">struct</span> RegExpTest {
    RegExpTest()
        : offset(0)
        , result(0)
    {
    }

    UString subject;
    <span class="enscript-type">int</span> offset;
    <span class="enscript-type">int</span> result;
    Vector&lt;<span class="enscript-type">int</span>, 32&gt; expectVector;
};

<span class="enscript-type">class</span> GlobalObject : <span class="enscript-type">public</span> JSGlobalObject {
<span class="enscript-type">private</span>:
    GlobalObject(JSGlobalData&amp;, Structure*, <span class="enscript-type">const</span> Vector&lt;UString&gt;&amp; arguments);

<span class="enscript-type">public</span>:
    <span class="enscript-type">typedef</span> JSGlobalObject Base;

    <span class="enscript-type">static</span> GlobalObject* create(JSGlobalData&amp; globalData, Structure* structure, <span class="enscript-type">const</span> Vector&lt;UString&gt;&amp; arguments)
    {
        <span class="enscript-keyword">return</span> <span class="enscript-keyword">new</span> (NotNull, allocateCell&lt;GlobalObject&gt;(globalData.heap)) GlobalObject(globalData, structure, arguments);
    }

    <span class="enscript-type">static</span> <span class="enscript-type">const</span> ClassInfo s_info;

    <span class="enscript-type">static</span> Structure* createStructure(JSGlobalData&amp; globalData, JSValue prototype)
    {
        <span class="enscript-keyword">return</span> Structure::create(globalData, 0, prototype, TypeInfo(GlobalObjectType, StructureFlags), &amp;s_info);
    }

<span class="enscript-type">protected</span>:
    <span class="enscript-type">void</span> finishCreation(JSGlobalData&amp; globalData, <span class="enscript-type">const</span> Vector&lt;UString&gt;&amp; arguments)
    {
        <span class="enscript-reference">Base</span>::finishCreation(globalData);
        UNUSED_PARAM(arguments);
    }
};

<span class="enscript-function-name">COMPILE_ASSERT</span>(!IsInteger&lt;GlobalObject&gt;::value, WTF_IsInteger_GlobalObject_false);
<span class="enscript-function-name">ASSERT_CLASS_FITS_IN_CELL</span>(GlobalObject);

<span class="enscript-type">const</span> ClassInfo GlobalObject::s_info = { <span class="enscript-string">&quot;global&quot;</span>, &amp;JSGlobalObject::s_info, 0, ExecState::globalObjectTable, CREATE_METHOD_TABLE(GlobalObject) };

<span class="enscript-function-name">GlobalObject::GlobalObject</span>(JSGlobalData&amp; globalData, Structure* structure, <span class="enscript-type">const</span> Vector&lt;UString&gt;&amp; arguments)
    : JSGlobalObject(globalData, structure)
{
    finishCreation(globalData, arguments);
}

<span class="enscript-comment">// Use SEH for Release builds only to get rid of the crash report dialog
</span><span class="enscript-comment">// (luckily the same tests fail in Release and Debug builds so far). Need to
</span><span class="enscript-comment">// be in a separate main function because the realMain function requires object
</span><span class="enscript-comment">// unwinding.
</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">COMPILER</span>(<span class="enscript-variable-name">MSVC</span>) &amp;&amp; !<span class="enscript-variable-name">COMPILER</span>(<span class="enscript-variable-name">INTEL</span>) &amp;&amp; !<span class="enscript-reference">defined</span>(<span class="enscript-variable-name">_DEBUG</span>) &amp;&amp; !<span class="enscript-variable-name">OS</span>(<span class="enscript-variable-name">WINCE</span>)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TRY</span>       __try {
#<span class="enscript-reference">define</span> <span class="enscript-function-name">EXCEPT</span>(x) } __except (EXCEPTION_EXECUTE_HANDLER) { x; }
#<span class="enscript-reference">else</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TRY</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">EXCEPT</span>(x)
#<span class="enscript-reference">endif</span>

<span class="enscript-type">int</span> <span class="enscript-function-name">realMain</span>(<span class="enscript-type">int</span> argc, <span class="enscript-type">char</span>** argv);

<span class="enscript-type">int</span> <span class="enscript-function-name">main</span>(<span class="enscript-type">int</span> argc, <span class="enscript-type">char</span>** argv)
{
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">OS</span>(<span class="enscript-variable-name">WINDOWS</span>)
#<span class="enscript-reference">if</span> !<span class="enscript-variable-name">OS</span>(<span class="enscript-variable-name">WINCE</span>)
    <span class="enscript-comment">// Cygwin calls ::SetErrorMode(SEM_FAILCRITICALERRORS), which we will inherit. This is bad for
</span>    <span class="enscript-comment">// testing/debugging, as it causes the post-mortem debugger not to be invoked. We reset the
</span>    <span class="enscript-comment">// error mode here to work around Cygwin's behavior. See &lt;<a href="http://webkit.org/b/55222">http://webkit.org/b/55222</a>&gt;.
</span>    ::SetErrorMode(0);
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">_DEBUG</span>)
    _CrtSetReportFile(_CRT_WARN, _CRTDBG_FILE_STDERR);
    _CrtSetReportMode(_CRT_WARN, _CRTDBG_MODE_FILE);
    _CrtSetReportFile(_CRT_ERROR, _CRTDBG_FILE_STDERR);
    _CrtSetReportMode(_CRT_ERROR, _CRTDBG_MODE_FILE);
    _CrtSetReportFile(_CRT_ASSERT, _CRTDBG_FILE_STDERR);
    _CrtSetReportMode(_CRT_ASSERT, _CRTDBG_MODE_FILE);
#<span class="enscript-reference">endif</span>

    timeBeginPeriod(1);
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">PLATFORM</span>(<span class="enscript-variable-name">QT</span>)
    QCoreApplication app(argc, argv);
#<span class="enscript-reference">endif</span>

    <span class="enscript-comment">// Initialize JSC before getting JSGlobalData.
</span>    <span class="enscript-reference">JSC</span>::initializeThreading();

    <span class="enscript-comment">// We can't use destructors in the following code because it uses Windows
</span>    <span class="enscript-comment">// Structured Exception Handling
</span>    <span class="enscript-type">int</span> res = 0;
    TRY
        res = realMain(argc, argv);
    EXCEPT(res = 3)
    <span class="enscript-keyword">return</span> res;
}

<span class="enscript-type">static</span> <span class="enscript-type">bool</span> <span class="enscript-function-name">testOneRegExp</span>(JSGlobalData&amp; globalData, RegExp* regexp, RegExpTest* regExpTest, <span class="enscript-type">bool</span> verbose, <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> lineNumber)
{
    <span class="enscript-type">bool</span> result = true;
    Vector&lt;<span class="enscript-type">int</span>, 32&gt; outVector;
    outVector.resize(regExpTest-&gt;expectVector.size());
    <span class="enscript-type">int</span> matchResult = regexp-&gt;match(globalData, regExpTest-&gt;subject, regExpTest-&gt;offset, outVector);

    <span class="enscript-keyword">if</span> (matchResult != regExpTest-&gt;result) {
        result = false;
        <span class="enscript-keyword">if</span> (verbose)
            printf(<span class="enscript-string">&quot;Line %d: results mismatch - expected %d got %d\n&quot;</span>, lineNumber, regExpTest-&gt;result, matchResult);
    } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (matchResult != -1) {
        <span class="enscript-keyword">if</span> (outVector.size() != regExpTest-&gt;expectVector.size()) {
            result = false;
            <span class="enscript-keyword">if</span> (verbose)
                printf(<span class="enscript-string">&quot;Line %d: output vector size mismatch - expected %lu got %lu\n&quot;</span>, lineNumber, regExpTest-&gt;expectVector.size(), outVector.size());
        } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (outVector.size() % 2) {
            result = false;
            <span class="enscript-keyword">if</span> (verbose)
                printf(<span class="enscript-string">&quot;Line %d: output vector size is odd (%lu), should be even\n&quot;</span>, lineNumber, outVector.size());
        } <span class="enscript-keyword">else</span> {
            <span class="enscript-comment">// Check in pairs since the first value of the pair could be -1 in which case the second doesn't matter.
</span>            size_t pairCount = outVector.size() / 2;
            <span class="enscript-keyword">for</span> (size_t i = 0; i &lt; pairCount; ++i) {
                size_t startIndex = i*2;
                <span class="enscript-keyword">if</span> (outVector[startIndex] != regExpTest-&gt;expectVector[startIndex]) {
                    result = false;
                    <span class="enscript-keyword">if</span> (verbose)
                        printf(<span class="enscript-string">&quot;Line %d: output vector mismatch at index %lu - expected %d got %d\n&quot;</span>, lineNumber, startIndex, regExpTest-&gt;expectVector[startIndex], outVector[startIndex]);
                }
                <span class="enscript-keyword">if</span> ((i &gt; 0) &amp;&amp; (regExpTest-&gt;expectVector[startIndex] != -1) &amp;&amp; (outVector[startIndex+1] != regExpTest-&gt;expectVector[startIndex+1])) {
                    result = false;
                    <span class="enscript-keyword">if</span> (verbose)
                        printf(<span class="enscript-string">&quot;Line %d: output vector mismatch at index %lu - expected %d got %d\n&quot;</span>, lineNumber, startIndex+1, regExpTest-&gt;expectVector[startIndex+1], outVector[startIndex+1]);
                }
            }
        }
    }

    <span class="enscript-keyword">return</span> result;
}

<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">scanString</span>(<span class="enscript-type">char</span>* buffer, <span class="enscript-type">int</span> bufferLength, UStringBuilder&amp; builder, <span class="enscript-type">char</span> termChar)
{
    <span class="enscript-type">bool</span> escape = false;
    
    <span class="enscript-keyword">for</span> (<span class="enscript-type">int</span> i = 0; i &lt; bufferLength; ++i) {
        UChar c = buffer[i];
        
        <span class="enscript-keyword">if</span> (escape) {
            <span class="enscript-keyword">switch</span> (c) {
            <span class="enscript-keyword">case</span> <span class="enscript-string">'0'</span>:
                c = <span class="enscript-string">'\0'</span>;
                <span class="enscript-keyword">break</span>;
            <span class="enscript-keyword">case</span> <span class="enscript-string">'a'</span>:
                c = <span class="enscript-string">'\a'</span>;
                <span class="enscript-keyword">break</span>;
            <span class="enscript-keyword">case</span> <span class="enscript-string">'b'</span>:
                c = <span class="enscript-string">'\b'</span>;
                <span class="enscript-keyword">break</span>;
            <span class="enscript-keyword">case</span> <span class="enscript-string">'f'</span>:
                c = <span class="enscript-string">'\f'</span>;
                <span class="enscript-keyword">break</span>;
            <span class="enscript-keyword">case</span> <span class="enscript-string">'n'</span>:
                c = <span class="enscript-string">'\n'</span>;
                <span class="enscript-keyword">break</span>;
            <span class="enscript-keyword">case</span> <span class="enscript-string">'r'</span>:
                c = <span class="enscript-string">'\r'</span>;
                <span class="enscript-keyword">break</span>;
            <span class="enscript-keyword">case</span> <span class="enscript-string">'t'</span>:
                c = <span class="enscript-string">'\t'</span>;
                <span class="enscript-keyword">break</span>;
            <span class="enscript-keyword">case</span> <span class="enscript-string">'v'</span>:
                c = <span class="enscript-string">'\v'</span>;
                <span class="enscript-keyword">break</span>;
            <span class="enscript-keyword">case</span> <span class="enscript-string">'\\'</span>:
                c = <span class="enscript-string">'\\'</span>;
                <span class="enscript-keyword">break</span>;
            <span class="enscript-keyword">case</span> <span class="enscript-string">'?'</span>:
                c = <span class="enscript-string">'\?'</span>;
                <span class="enscript-keyword">break</span>;
            <span class="enscript-keyword">case</span> <span class="enscript-string">'u'</span>:
                <span class="enscript-keyword">if</span> ((i + 4) &gt;= bufferLength)
                    <span class="enscript-keyword">return</span> -1;
                <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> charValue;
                <span class="enscript-keyword">if</span> (sscanf(buffer+i+1, <span class="enscript-string">&quot;%04x&quot;</span>, &amp;charValue) != 1)
                    <span class="enscript-keyword">return</span> -1;
                c = static_cast&lt;UChar&gt;(charValue);
                i += 4;
                <span class="enscript-keyword">break</span>;
            }
            
            builder.append(c);
            escape = false;
        } <span class="enscript-keyword">else</span> {
            <span class="enscript-keyword">if</span> (c == termChar)
                <span class="enscript-keyword">return</span> i;

            <span class="enscript-keyword">if</span> (c == <span class="enscript-string">'\\'</span>)
                escape = true;
            <span class="enscript-keyword">else</span>
                builder.append(c);
        }
    }

    <span class="enscript-keyword">return</span> -1;
}

<span class="enscript-type">static</span> RegExp* <span class="enscript-function-name">parseRegExpLine</span>(JSGlobalData&amp; globalData, <span class="enscript-type">char</span>* line, <span class="enscript-type">int</span> lineLength)
{
    UStringBuilder pattern;
    
    <span class="enscript-keyword">if</span> (line[0] != <span class="enscript-string">'/'</span>)
        <span class="enscript-keyword">return</span> 0;

    <span class="enscript-type">int</span> i = scanString(line + 1, lineLength - 1, pattern, <span class="enscript-string">'/'</span>) + 1;

    <span class="enscript-keyword">if</span> ((i &gt;= lineLength) || (line[i] != <span class="enscript-string">'/'</span>))
        <span class="enscript-keyword">return</span> 0;

    ++i;

    <span class="enscript-keyword">return</span> RegExp::create(globalData, pattern.toUString(), regExpFlags(line + i));
}

<span class="enscript-type">static</span> RegExpTest* <span class="enscript-function-name">parseTestLine</span>(<span class="enscript-type">char</span>* line, <span class="enscript-type">int</span> lineLength)
{
    UStringBuilder subjectString;
    
    <span class="enscript-keyword">if</span> ((line[0] != <span class="enscript-string">' '</span>) || (line[1] != <span class="enscript-string">'&quot;'</span>))
        <span class="enscript-keyword">return</span> 0;

    <span class="enscript-type">int</span> i = scanString(line + 2, lineLength - 2, subjectString, <span class="enscript-string">'&quot;'</span>) + 2;

    <span class="enscript-keyword">if</span> ((i &gt;= (lineLength - 2)) || (line[i] != <span class="enscript-string">'&quot;'</span>) || (line[i+1] != <span class="enscript-string">','</span>) || (line[i+2] != <span class="enscript-string">' '</span>))
        <span class="enscript-keyword">return</span> 0;

    i += 3;
    
    <span class="enscript-type">int</span> offset;
    
    <span class="enscript-keyword">if</span> (sscanf(line + i, <span class="enscript-string">&quot;%d, &quot;</span>, &amp;offset) != 1)
        <span class="enscript-keyword">return</span> 0;

    <span class="enscript-keyword">while</span> (line[i] &amp;&amp; line[i] != <span class="enscript-string">' '</span>)
        ++i;

    ++i;
    
    <span class="enscript-type">int</span> matchResult;
    
    <span class="enscript-keyword">if</span> (sscanf(line + i, <span class="enscript-string">&quot;%d, &quot;</span>, &amp;matchResult) != 1)
        <span class="enscript-keyword">return</span> 0;
    
    <span class="enscript-keyword">while</span> (line[i] &amp;&amp; line[i] != <span class="enscript-string">' '</span>)
        ++i;
    
    ++i;
    
    <span class="enscript-keyword">if</span> (line[i++] != <span class="enscript-string">'('</span>)
        <span class="enscript-keyword">return</span> 0;

    <span class="enscript-type">int</span> start, end;
    
    RegExpTest* result = <span class="enscript-keyword">new</span> RegExpTest();
    
    result-&gt;subject = subjectString.toUString();
    result-&gt;offset = offset;
    result-&gt;result = matchResult;

    <span class="enscript-keyword">while</span> (line[i] &amp;&amp; line[i] != <span class="enscript-string">')'</span>) {
        <span class="enscript-keyword">if</span> (sscanf(line + i, <span class="enscript-string">&quot;%d, %d&quot;</span>, &amp;start, &amp;end) != 2) {
            <span class="enscript-keyword">delete</span> result;
            <span class="enscript-keyword">return</span> 0;
        }

        result-&gt;expectVector.append(start);
        result-&gt;expectVector.append(end);

        <span class="enscript-keyword">while</span> (line[i] &amp;&amp; (line[i] != <span class="enscript-string">','</span>) &amp;&amp; (line[i] != <span class="enscript-string">')'</span>))
            i++;
        i++;
        <span class="enscript-keyword">while</span> (line[i] &amp;&amp; (line[i] != <span class="enscript-string">','</span>) &amp;&amp; (line[i] != <span class="enscript-string">')'</span>))
            i++;

        <span class="enscript-keyword">if</span> (line[i] == <span class="enscript-string">')'</span>)
            <span class="enscript-keyword">break</span>;
        <span class="enscript-keyword">if</span> (!line[i] || (line[i] != <span class="enscript-string">','</span>)) {
            <span class="enscript-keyword">delete</span> result;
            <span class="enscript-keyword">return</span> 0;
        }
        i++;
    }

    <span class="enscript-keyword">return</span> result;
}

<span class="enscript-type">static</span> <span class="enscript-type">bool</span> <span class="enscript-function-name">runFromFiles</span>(GlobalObject* globalObject, <span class="enscript-type">const</span> Vector&lt;UString&gt;&amp; files, <span class="enscript-type">bool</span> verbose)
{
    UString script;
    UString fileName;
    Vector&lt;<span class="enscript-type">char</span>&gt; scriptBuffer;
    <span class="enscript-type">unsigned</span> tests = 0;
    <span class="enscript-type">unsigned</span> failures = 0;
    <span class="enscript-type">char</span>* lineBuffer = <span class="enscript-keyword">new</span> <span class="enscript-type">char</span>[MaxLineLength + 1];

    JSGlobalData&amp; globalData = globalObject-&gt;globalData();

    <span class="enscript-type">bool</span> success = true;
    <span class="enscript-keyword">for</span> (size_t i = 0; i &lt; files.size(); i++) {
        FILE* testCasesFile = fopen(files[i].utf8().data(), <span class="enscript-string">&quot;rb&quot;</span>);

        <span class="enscript-keyword">if</span> (!testCasesFile) {
            printf(<span class="enscript-string">&quot;Unable to open test data file \&quot;%s\&quot;\n&quot;</span>, files[i].utf8().data());
            <span class="enscript-keyword">continue</span>;
        }
            
        RegExp* regexp = 0;
        size_t lineLength = 0;
        <span class="enscript-type">char</span>* linePtr = 0;
        <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> lineNumber = 0;

        <span class="enscript-keyword">while</span> ((linePtr = fgets(&amp;lineBuffer[0], MaxLineLength, testCasesFile))) {
            lineLength = strlen(linePtr);
            <span class="enscript-keyword">if</span> (linePtr[lineLength - 1] == <span class="enscript-string">'\n'</span>) {
                linePtr[lineLength - 1] = <span class="enscript-string">'\0'</span>;
                --lineLength;
            }
            ++lineNumber;

            <span class="enscript-keyword">if</span> (linePtr[0] == <span class="enscript-string">'#'</span>)
                <span class="enscript-keyword">continue</span>;

            <span class="enscript-keyword">if</span> (linePtr[0] == <span class="enscript-string">'/'</span>) {
                regexp = parseRegExpLine(globalData, linePtr, lineLength);
            } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (linePtr[0] == <span class="enscript-string">' '</span>) {
                RegExpTest* regExpTest = parseTestLine(linePtr, lineLength);
                
                <span class="enscript-keyword">if</span> (regexp &amp;&amp; regExpTest) {
                    ++tests;
                    <span class="enscript-keyword">if</span> (!testOneRegExp(globalData, regexp, regExpTest, verbose, lineNumber)) {
                        failures++;
                        printf(<span class="enscript-string">&quot;Failure on line %u\n&quot;</span>, lineNumber);
                    }
                }
                
                <span class="enscript-keyword">if</span> (regExpTest)
                    <span class="enscript-keyword">delete</span> regExpTest;
            }
        }
        
        fclose(testCasesFile);
    }

    <span class="enscript-keyword">if</span> (failures)
        printf(<span class="enscript-string">&quot;%u tests run, %u failures\n&quot;</span>, tests, failures);
    <span class="enscript-keyword">else</span>
        printf(<span class="enscript-string">&quot;%u tests passed\n&quot;</span>, tests);

    <span class="enscript-keyword">delete</span>[] lineBuffer;

    globalData.dumpSampleData(globalObject-&gt;globalExec());
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">ENABLE</span>(<span class="enscript-variable-name">REGEXP_TRACING</span>)
    globalData.dumpRegExpTrace();
#<span class="enscript-reference">endif</span>
    <span class="enscript-keyword">return</span> success;
}

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">RUNNING_FROM_XCODE</span> 0

<span class="enscript-type">static</span> NO_RETURN <span class="enscript-type">void</span> <span class="enscript-function-name">printUsageStatement</span>(<span class="enscript-type">bool</span> help = false)
{
    fprintf(stderr, <span class="enscript-string">&quot;Usage: regexp_test [options] file\n&quot;</span>);
    fprintf(stderr, <span class="enscript-string">&quot;  -h|--help  Prints this help message\n&quot;</span>);
    fprintf(stderr, <span class="enscript-string">&quot;  -v|--verbose  Verbose output\n&quot;</span>);

    exit(help ? EXIT_SUCCESS : EXIT_FAILURE);
}

<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">parseArguments</span>(<span class="enscript-type">int</span> argc, <span class="enscript-type">char</span>** argv, CommandLine&amp; options)
{
    <span class="enscript-type">int</span> i = 1;
    <span class="enscript-keyword">for</span> (; i &lt; argc; ++i) {
        <span class="enscript-type">const</span> <span class="enscript-type">char</span>* arg = argv[i];
        <span class="enscript-keyword">if</span> (!strcmp(arg, <span class="enscript-string">&quot;-h&quot;</span>) || !strcmp(arg, <span class="enscript-string">&quot;--help&quot;</span>))
            printUsageStatement(true);
        <span class="enscript-keyword">if</span> (!strcmp(arg, <span class="enscript-string">&quot;-v&quot;</span>) || !strcmp(arg, <span class="enscript-string">&quot;--verbose&quot;</span>))
            options.verbose = true;
        <span class="enscript-keyword">else</span>
            options.files.append(argv[i]);
    }

    <span class="enscript-keyword">for</span> (; i &lt; argc; ++i)
        options.arguments.append(argv[i]);
}

<span class="enscript-type">int</span> <span class="enscript-function-name">realMain</span>(<span class="enscript-type">int</span> argc, <span class="enscript-type">char</span>** argv)
{
    RefPtr&lt;JSGlobalData&gt; globalData = JSGlobalData::create(ThreadStackTypeLarge, LargeHeap);
    JSLockHolder lock(globalData.get());

    CommandLine options;
    parseArguments(argc, argv, options);

    GlobalObject* globalObject = GlobalObject::create(*globalData, GlobalObject::createStructure(*globalData, jsNull()), options.arguments);
    <span class="enscript-type">bool</span> success = runFromFiles(globalObject, options.files, options.verbose);

    <span class="enscript-keyword">return</span> success ? 0 : 3;
}
</pre>
<hr />
</body></html>